<!DOCTYPE html>

<html lang="en" data-content_root="../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Emulation and leakage simulation &#8212; pyecsca 0.3.2 documentation</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=d10597a4" />
    <link rel="stylesheet" type="text/css" href="../_static/alabaster.css?v=bf281230" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx_paramlinks.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-design.min.css?v=87e54e7c" />
    <link rel="stylesheet" type="text/css" href="../_static/nbsphinx-code-cells.css" />
    <link rel="stylesheet" type="text/css" href="../_static/custom.css?v=de02a091" />
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.3.0/css/all.min.css" />
    <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;1,100;1,200;1,300;1,400;1,500;1,600;1,700&family=IBM+Plex+Sans:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;1,100;1,200;1,300;1,400;1,500;1,600;1,700&display=swap" />
    <script src="../_static/documentation_options.js?v=71d9d8e6"></script>
    <script src="../_static/doctools.js?v=9a2dae69"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/design-tabs.js?v=f930bc37"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="icon" href="../_static/logo_black.png"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Measurement" href="measurement.html" />
    <link rel="prev" title="Code generation" href="codegen.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  <div class="document">
    
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
<p class="logo">
  <a href="../index.html">
    <img class="logo" src="../_static/logo_black.png" alt="Logo" />
    
    <h1 class="logo logo-name">pyecsca</h1>
    
  </a>
</p>










<h3>Navigation</h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../installation.html"><span class="fas fa-screwdriver-wrench fa-fw"></span> Installation</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../notebooks.html"><span class="fas fa-hand-pointer fa-fw"></span> Notebooks</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="configuration_space.html">Configuration space</a></li>
<li class="toctree-l2"><a class="reference internal" href="simulation.html">Simulation</a></li>
<li class="toctree-l2"><a class="reference internal" href="codegen.html">Code generation</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Emulation and leakage simulation</a></li>
<li class="toctree-l2"><a class="reference internal" href="measurement.html">Measurement</a></li>
<li class="toctree-l2"><a class="reference internal" href="visualization.html">Visualization</a></li>
<li class="toctree-l2"><a class="reference internal" href="smartcards.html">Smartcards</a></li>
<li class="toctree-l2"><a class="reference internal" href="re/formulas.html">Exploration of formulas in open-source ECC libraries</a></li>
<li class="toctree-l2"><a class="reference internal" href="re/rpa.html">RPA-based reverse-engineering</a></li>
<li class="toctree-l2"><a class="reference internal" href="re/zvp.html">ZVP-based reverse-engineering</a></li>
<li class="toctree-l2"><a class="reference internal" href="re/epa.html">EPA-based reverse engineering</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../api.html"><span class="fas fa-code fa-fw"></span> API reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../libraries.html"><span class="fas fa-server fa-fw"></span> ECC in Libraries</a></li>
<li class="toctree-l1"><a class="reference internal" href="../references.html"><span class="fas fa-asterisk fa-fw"></span> References</a></li>
</ul>

<ul style="margin-top: 1em">
    <li class="toctree-l1"><a href="https://github.com/J08nY/pyecsca/"><i class="fab fa-fw fa-github"></i> Source code</a></li>
    <li class="toctree-l1"><a href="https://pypi.org/project/pyecsca/"><i class="fas fa-fw fa-file"></i> Releases</a></li>
</ul><div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
  <li><a href="../notebooks.html"><span class="fas fa-hand-pointer fa-fw"></span> Notebooks</a><ul>
      <li>Previous: <a href="codegen.html" title="previous chapter">Code generation</a></li>
      <li>Next: <a href="measurement.html" title="next chapter">Measurement</a></li>
  </ul></li>
  </ul></li>
</ul>
</div>
<search id="searchbox" style="display: none" role="search">
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" placeholder="Search"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <a href="https://mybinder.org/v2/gh/J08nY/pyecsca-notebook/HEAD?labpath=emulator.ipynb" class="sd-badge sd-outline-primary">MyBinder</a><section id="Emulation-and-leakage-simulation">
<h1>Emulation and leakage simulation<a class="headerlink" href="#Emulation-and-leakage-simulation" title="Link to this heading">¶</a></h1>
<p>This notebook demonstrates the functionality of the <code class="docutils literal notranslate"><span class="pre">EmulatorTarget</span></code> class, which can emulate <strong>pyecsca</strong> generated C implementations for <code class="docutils literal notranslate"><span class="pre">STM32F3</span></code> target using Rainbow as a basis as well as simulate side-channel leakage.</p>
<section id="Initialisation">
<h2>Initialisation<a class="headerlink" href="#Initialisation" title="Link to this heading">¶</a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pyecsca.ec.mult</span> <span class="kn">import</span> <span class="n">LTRMultiplier</span>
<span class="kn">from</span> <span class="nn">pyecsca.ec.mod</span> <span class="kn">import</span> <span class="n">mod</span>
<span class="kn">from</span> <span class="nn">pyecsca.ec.point</span> <span class="kn">import</span> <span class="n">Point</span><span class="p">,</span> <span class="n">InfinityPoint</span>
<span class="kn">from</span> <span class="nn">pyecsca.ec.model</span> <span class="kn">import</span> <span class="n">ShortWeierstrassModel</span>
<span class="kn">from</span> <span class="nn">pyecsca.ec.curve</span> <span class="kn">import</span> <span class="n">EllipticCurve</span>
<span class="kn">from</span> <span class="nn">pyecsca.ec.params</span> <span class="kn">import</span> <span class="n">DomainParameters</span>
<span class="kn">from</span> <span class="nn">pyecsca.ec.key_generation</span> <span class="kn">import</span> <span class="n">KeyGeneration</span>
<span class="kn">from</span> <span class="nn">pyecsca.ec.key_agreement</span> <span class="kn">import</span> <span class="n">ECDH_SHA1</span>
<span class="kn">from</span> <span class="nn">pyecsca.ec.configuration</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">pyecsca.codegen.client</span> <span class="kn">import</span> <span class="n">EmulatorTarget</span>
<span class="kn">from</span> <span class="nn">pyecsca.codegen.common</span> <span class="kn">import</span> <span class="n">Platform</span>
<span class="kn">from</span> <span class="nn">pyecsca.codegen.common</span> <span class="kn">import</span> <span class="n">DeviceConfiguration</span>
<span class="kn">from</span> <span class="nn">pyecsca.codegen.builder</span> <span class="kn">import</span> <span class="n">render</span>
<span class="kn">from</span> <span class="nn">pyecsca.sca.trace</span> <span class="kn">import</span> <span class="n">Trace</span>
<span class="kn">from</span> <span class="nn">pyecsca.sca.trace.plot</span> <span class="kn">import</span> <span class="n">plot_trace</span>
<span class="kn">from</span> <span class="nn">pyecsca.sca.trace.process</span> <span class="kn">import</span> <span class="n">rolling_mean</span>


<span class="kn">from</span> <span class="nn">rainbow</span> <span class="kn">import</span> <span class="n">TraceConfig</span>
<span class="kn">from</span> <span class="nn">rainbow.leakage_models</span> <span class="kn">import</span> <span class="n">HammingWeight</span>

<span class="kn">from</span> <span class="nn">binascii</span> <span class="kn">import</span> <span class="n">hexlify</span>
<span class="kn">from</span> <span class="nn">random</span> <span class="kn">import</span> <span class="n">randbytes</span><span class="p">,</span> <span class="n">randint</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">holoviews</span> <span class="k">as</span> <span class="nn">hv</span>
<span class="kn">from</span> <span class="nn">subprocess</span> <span class="kn">import</span> <span class="n">run</span>
<span class="kn">from</span> <span class="nn">os.path</span> <span class="kn">import</span> <span class="n">join</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">copy</span>
</pre></div>
</div>
</div>
<p>We first define the elliptic curve parameters we are going to be using for the demonstration.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="n">ShortWeierstrassModel</span><span class="p">()</span>
<span class="n">coords</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">coordinates</span><span class="p">[</span><span class="s2">&quot;projective&quot;</span><span class="p">]</span>
<span class="n">p</span> <span class="o">=</span> <span class="mh">0xd7d1247f</span>
<span class="n">a</span> <span class="o">=</span> <span class="n">mod</span><span class="p">(</span><span class="mh">0xa4a44016</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
<span class="n">b</span> <span class="o">=</span> <span class="n">mod</span><span class="p">(</span><span class="mh">0x73f76716</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
<span class="n">n</span> <span class="o">=</span> <span class="mh">0xd7d2a475</span>
<span class="n">h</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">gx</span><span class="p">,</span> <span class="n">gy</span><span class="p">,</span> <span class="n">gz</span> <span class="o">=</span> <span class="n">mod</span><span class="p">(</span><span class="mh">0x54eed6d7</span><span class="p">,</span> <span class="n">p</span><span class="p">),</span> <span class="n">mod</span><span class="p">(</span><span class="mh">0x6f1e55ac</span><span class="p">,</span> <span class="n">p</span><span class="p">),</span> <span class="n">mod</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
<span class="n">generator</span> <span class="o">=</span> <span class="n">Point</span><span class="p">(</span><span class="n">coords</span><span class="p">,</span> <span class="n">X</span><span class="o">=</span><span class="n">gx</span><span class="p">,</span> <span class="n">Y</span><span class="o">=</span><span class="n">gy</span><span class="p">,</span> <span class="n">Z</span><span class="o">=</span><span class="n">gz</span><span class="p">)</span>
<span class="n">neutral</span> <span class="o">=</span> <span class="n">InfinityPoint</span><span class="p">(</span><span class="n">coords</span><span class="p">)</span>

<span class="n">curve</span> <span class="o">=</span> <span class="n">EllipticCurve</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">coords</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">neutral</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;a&quot;</span><span class="p">:</span> <span class="n">a</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">:</span> <span class="n">b</span><span class="p">})</span>
<span class="n">params</span> <span class="o">=</span> <span class="n">DomainParameters</span><span class="p">(</span><span class="n">curve</span><span class="p">,</span> <span class="n">generator</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">h</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>We create and initialize an instance of the <code class="docutils literal notranslate"><span class="pre">EmulatorTarget</span></code> class with the above EC parameters and the <code class="docutils literal notranslate"><span class="pre">TraceConfig</span></code> class instance, which configures the simulated leakage trace to contain the Hamming Weight of the emulator’s register values.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">target</span> <span class="o">=</span> <span class="n">EmulatorTarget</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">coords</span><span class="p">,</span> <span class="n">trace_config</span><span class="o">=</span><span class="n">TraceConfig</span><span class="p">(</span><span class="n">register</span><span class="o">=</span><span class="n">HammingWeight</span><span class="p">()))</span>
</pre></div>
</div>
</div>
<p>We generate code and build it using <strong>pyecsca</strong> (for more details see <code class="docutils literal notranslate"><span class="pre">codegen.ipynb</span></code> notebook) and load the resulting binary into the emulator.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">platform</span> <span class="o">=</span> <span class="n">Platform</span><span class="o">.</span><span class="n">STM32F3</span>
<span class="n">hash_type</span> <span class="o">=</span> <span class="n">HashType</span><span class="o">.</span><span class="n">SHA1</span>
<span class="n">mod_rand</span> <span class="o">=</span> <span class="n">RandomMod</span><span class="o">.</span><span class="n">REDUCE</span>
<span class="n">mult</span> <span class="o">=</span> <span class="n">Multiplication</span><span class="o">.</span><span class="n">BASE</span>
<span class="n">sqr</span> <span class="o">=</span> <span class="n">Squaring</span><span class="o">.</span><span class="n">BASE</span>
<span class="n">red</span> <span class="o">=</span> <span class="n">Reduction</span><span class="o">.</span><span class="n">BASE</span>
<span class="n">inv</span> <span class="o">=</span> <span class="n">Inversion</span><span class="o">.</span><span class="n">GCD</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">ShortWeierstrassModel</span><span class="p">()</span>
<span class="n">coords</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">coordinates</span><span class="p">[</span><span class="s2">&quot;projective&quot;</span><span class="p">]</span>
<span class="n">add</span> <span class="o">=</span> <span class="n">coords</span><span class="o">.</span><span class="n">formulas</span><span class="p">[</span><span class="s2">&quot;add-1998-cmo&quot;</span><span class="p">]</span>
<span class="n">dbl</span> <span class="o">=</span> <span class="n">coords</span><span class="o">.</span><span class="n">formulas</span><span class="p">[</span><span class="s2">&quot;dbl-1998-cmo&quot;</span><span class="p">]</span>
<span class="n">scl</span> <span class="o">=</span> <span class="n">coords</span><span class="o">.</span><span class="n">formulas</span><span class="p">[</span><span class="s2">&quot;z&quot;</span><span class="p">]</span>
<span class="n">formulas</span> <span class="o">=</span> <span class="p">[</span><span class="n">add</span><span class="p">,</span> <span class="n">dbl</span><span class="p">,</span> <span class="n">scl</span><span class="p">]</span>
<span class="n">scalarmult</span> <span class="o">=</span> <span class="n">LTRMultiplier</span><span class="p">(</span><span class="n">add</span><span class="p">,</span> <span class="n">dbl</span><span class="p">,</span> <span class="n">scl</span><span class="p">)</span>

<span class="n">config</span> <span class="o">=</span> <span class="n">DeviceConfiguration</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">coords</span><span class="p">,</span> <span class="n">formulas</span><span class="p">,</span> <span class="n">scalarmult</span><span class="p">,</span>
                                                     <span class="n">hash_type</span><span class="p">,</span> <span class="n">mod_rand</span><span class="p">,</span> <span class="n">mult</span><span class="p">,</span> <span class="n">sqr</span><span class="p">,</span> <span class="n">red</span><span class="p">,</span>
                                                     <span class="n">inv</span><span class="p">,</span> <span class="n">platform</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

<span class="n">directory</span><span class="p">,</span> <span class="n">elf_name</span><span class="p">,</span> <span class="n">hex_name</span> <span class="o">=</span> <span class="n">render</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>

<span class="n">run</span><span class="p">([</span><span class="s2">&quot;make&quot;</span><span class="p">],</span> <span class="n">cwd</span><span class="o">=</span><span class="n">directory</span><span class="p">)</span>
<span class="n">join</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="n">hex_name</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">target</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">binary</span><span class="o">=</span><span class="n">join</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="n">elf_name</span><span class="p">))</span>
</pre></div>
</div>
</div>
<p>For the emulated functions to work correctly, we need to set the parameters of the curve in the emulator.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">target</span><span class="o">.</span><span class="n">set_params</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
</pre></div>
</div>
</div>
</section>
<section id="Emulator-functionality">
<h2>Emulator functionality<a class="headerlink" href="#Emulator-functionality" title="Link to this heading">¶</a></h2>
<section id="Scalar-multiplication">
<h3>Scalar multiplication<a class="headerlink" href="#Scalar-multiplication" title="Link to this heading">¶</a></h3>
<p>Perform scalar multiplication on given point with given scalar and compare with pyecsca.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">scalar</span> <span class="o">=</span> <span class="n">randint</span><span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="mi">255</span><span class="p">)</span>
<span class="n">point</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">curve</span><span class="o">.</span><span class="n">affine_random</span><span class="p">()</span><span class="o">.</span><span class="n">to_model</span><span class="p">(</span><span class="n">coords</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">curve</span><span class="p">)</span>
<span class="n">emulatorResult</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">scalar_mult</span><span class="p">(</span><span class="n">scalar</span><span class="p">,</span> <span class="n">point</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">emulatorResult</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>We use pyecsca to validate correctness of the emulator result.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">generator</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">generator</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">curve</span><span class="o">.</span><span class="n">model</span>
<span class="n">coords</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">curve</span><span class="o">.</span><span class="n">coordinate_model</span>
<span class="n">add</span> <span class="o">=</span> <span class="n">coords</span><span class="o">.</span><span class="n">formulas</span><span class="p">[</span><span class="s2">&quot;add-1998-cmo&quot;</span><span class="p">]</span>
<span class="n">dbl</span> <span class="o">=</span> <span class="n">coords</span><span class="o">.</span><span class="n">formulas</span><span class="p">[</span><span class="s2">&quot;dbl-1998-cmo&quot;</span><span class="p">]</span>
<span class="n">scl</span> <span class="o">=</span> <span class="n">coords</span><span class="o">.</span><span class="n">formulas</span><span class="p">[</span><span class="s2">&quot;z&quot;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mult_sm</span> <span class="o">=</span> <span class="n">LTRMultiplier</span><span class="p">(</span><span class="n">add</span><span class="p">,</span> <span class="n">dbl</span><span class="p">,</span> <span class="n">scl</span><span class="p">)</span>
<span class="n">mult_sm</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">point</span><span class="p">)</span>

<span class="n">pyecscaResult</span> <span class="o">=</span> <span class="n">mult_sm</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">scalar</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">pyecscaResult</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">emulatorResult</span><span class="o">.</span><span class="n">equals</span><span class="p">(</span><span class="n">pyecscaResult</span><span class="p">))</span>
</pre></div>
</div>
</div>
</section>
<section id="Key-generation">
<h3>Key generation<a class="headerlink" href="#Key-generation" title="Link to this heading">¶</a></h3>
<p>Generate private and public key.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">seed_bytes</span> <span class="o">=</span> <span class="n">randbytes</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span>
<span class="n">target</span><span class="o">.</span><span class="n">init_prng</span><span class="p">(</span><span class="n">seed_bytes</span><span class="p">)</span>
<span class="n">priv</span><span class="p">,</span> <span class="n">pub</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">generate</span><span class="p">()</span>
<span class="n">pub</span> <span class="o">=</span> <span class="n">pub</span><span class="o">.</span><span class="n">to_model</span><span class="p">(</span><span class="n">coords</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">curve</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;private key:&quot;</span><span class="p">,</span> <span class="n">priv</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;public key:&quot;</span><span class="p">,</span> <span class="n">pub</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>We check if we generated valid key pair using pyecsca.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">curve</span><span class="o">.</span><span class="n">is_on_curve</span><span class="p">(</span><span class="n">pub</span><span class="p">))</span>
<span class="n">pyecscaPub</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">curve</span><span class="o">.</span><span class="n">affine_multiply</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">generator</span><span class="o">.</span><span class="n">to_affine</span><span class="p">(),</span> <span class="n">priv</span><span class="p">)</span><span class="o">.</span><span class="n">to_model</span><span class="p">(</span><span class="n">coords</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">curve</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">pyecscaPub</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">pub</span><span class="o">.</span><span class="n">equals</span><span class="p">(</span><span class="n">pyecscaPub</span><span class="p">))</span>
</pre></div>
</div>
</div>
</section>
<section id="Setting-private-and-public-key">
<h3>Setting private and public key<a class="headerlink" href="#Setting-private-and-public-key" title="Link to this heading">¶</a></h3>
<p>In order to emulate <strong>ECDH</strong> and <strong>ECDSA</strong> algorithms, the emulator needs private and public keys set. This can be done by methods below.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Before private:&quot;</span><span class="p">,</span> <span class="n">target</span><span class="o">.</span><span class="n">privkey</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Before public:&quot;</span><span class="p">,</span> <span class="n">target</span><span class="o">.</span><span class="n">pubkey</span><span class="p">)</span>

<span class="n">target</span><span class="o">.</span><span class="n">set_privkey</span><span class="p">(</span><span class="n">priv</span><span class="p">)</span>
<span class="n">target</span><span class="o">.</span><span class="n">set_pubkey</span><span class="p">(</span><span class="n">pub</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;After private:&quot;</span><span class="p">,</span> <span class="n">target</span><span class="o">.</span><span class="n">privkey</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;After public:&quot;</span><span class="p">,</span> <span class="n">target</span><span class="o">.</span><span class="n">pubkey</span><span class="p">)</span>
</pre></div>
</div>
</div>
</section>
<section id="ECDH">
<h3>ECDH<a class="headerlink" href="#ECDH" title="Link to this heading">¶</a></h3>
<p>Perform key agreement using ECDH.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">other_priv</span><span class="p">,</span> <span class="n">other_pub</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">generate</span><span class="p">()</span>
<span class="n">other_pub</span> <span class="o">=</span> <span class="n">other_pub</span><span class="o">.</span><span class="n">to_model</span><span class="p">(</span><span class="n">coords</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">curve</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">shared_secret</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">ecdh</span><span class="p">(</span><span class="n">pub</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;shared secret:&quot;</span><span class="p">,</span> <span class="n">hexlify</span><span class="p">(</span><span class="n">shared_secret</span><span class="p">))</span>
</pre></div>
</div>
</div>
<p>Check the result is correct using pyecsca.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mult_ecdh</span> <span class="o">=</span> <span class="n">LTRMultiplier</span><span class="p">(</span><span class="n">add</span><span class="p">,</span> <span class="n">dbl</span><span class="p">,</span> <span class="n">scl</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ecdh_a</span> <span class="o">=</span> <span class="n">ECDH_SHA1</span><span class="p">(</span><span class="n">copy</span><span class="p">(</span><span class="n">mult_ecdh</span><span class="p">),</span> <span class="n">params</span><span class="p">,</span> <span class="n">pub</span><span class="p">,</span> <span class="n">other_priv</span><span class="p">)</span>
<span class="n">ecdh_b</span> <span class="o">=</span> <span class="n">ECDH_SHA1</span><span class="p">(</span><span class="n">copy</span><span class="p">(</span><span class="n">mult_ecdh</span><span class="p">),</span> <span class="n">params</span><span class="p">,</span> <span class="n">other_pub</span><span class="p">,</span> <span class="n">priv</span><span class="p">)</span>
<span class="n">ecdh_a_result</span> <span class="o">=</span> <span class="n">ecdh_a</span><span class="o">.</span><span class="n">perform</span><span class="p">()</span>
<span class="n">ecdh_b_result</span> <span class="o">=</span> <span class="n">ecdh_b</span><span class="o">.</span><span class="n">perform</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">hexlify</span><span class="p">(</span><span class="n">ecdh_a_result</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">hexlify</span><span class="p">(</span><span class="n">ecdh_b_result</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">ecdh_a_result</span> <span class="o">==</span> <span class="n">ecdh_b_result</span> <span class="o">==</span> <span class="n">shared_secret</span><span class="p">)</span>
</pre></div>
</div>
</div>
</section>
<section id="ECDSA">
<h3>ECDSA<a class="headerlink" href="#ECDSA" title="Link to this heading">¶</a></h3>
<p>Perform signing over given data and verify the signature.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;text&quot;</span>
<span class="n">signed_message</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">ecdsa_sign</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
<span class="n">res</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">ecdsa_verify</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">encode</span><span class="p">(),</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">signed_message</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;text1&quot;</span>
<span class="n">signed_message</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">ecdsa_sign</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
<span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;text2&quot;</span>
<span class="n">res</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">ecdsa_verify</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">encode</span><span class="p">(),</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">signed_message</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
</pre></div>
</div>
</div>
</section>
</section>
<section id="Leakage-simulation">
<h2>Leakage simulation<a class="headerlink" href="#Leakage-simulation" title="Link to this heading">¶</a></h2>
<p>While the <code class="docutils literal notranslate"><span class="pre">EmulatorTarget</span></code> performs the above methods, it simulates leakage. The leakage trace is stored in <code class="docutils literal notranslate"><span class="pre">self.trace</span></code> variable. In our case, the trace will contain dictionaries of type <code class="docutils literal notranslate"><span class="pre">{&quot;type&quot;:</span> <span class="pre">&quot;code&quot;,</span> <span class="pre">&quot;register&quot;:</span> <span class="pre">x}</span></code>, where <code class="docutils literal notranslate"><span class="pre">x</span></code> is Hamming Weight of the current register value. For other configurations of the trace, see <a class="reference external" href="https://github.com/Ledger-Donjon/rainbow">https://github.com/Ledger-Donjon/rainbow</a></p>
<section id="Leakage-trace-of-scalar-multiplication">
<h3>Leakage trace of scalar multiplication<a class="headerlink" href="#Leakage-trace-of-scalar-multiplication" title="Link to this heading">¶</a></h3>
<p>We perform scalar multiplication and look at the sample of the leakage trace in <code class="docutils literal notranslate"><span class="pre">EmulatorTarget</span></code>’s <code class="docutils literal notranslate"><span class="pre">trace</span></code> variable.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">scalar</span> <span class="o">=</span> <span class="mi">229</span>
<span class="n">point</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">curve</span><span class="o">.</span><span class="n">affine_random</span><span class="p">()</span><span class="o">.</span><span class="n">to_model</span><span class="p">(</span><span class="n">coords</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">curve</span><span class="p">)</span>
<span class="n">target</span><span class="o">.</span><span class="n">trace</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">emulatorResult</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">scalar_mult</span><span class="p">(</span><span class="n">scalar</span><span class="p">,</span> <span class="n">point</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">target</span><span class="o">.</span><span class="n">trace</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">10</span><span class="p">])</span>
</pre></div>
</div>
</div>
<p>To use the pyecsca’s functionality of working with leakage traces, we transform the trace from dictionary to pyecsca’s <code class="docutils literal notranslate"><span class="pre">Trace</span></code> using <code class="docutils literal notranslate"><span class="pre">EmulatorTarget</span></code>’s <code class="docutils literal notranslate"><span class="pre">process_trace</span></code> method.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">trace</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">transform_trace</span><span class="p">()</span>
<br/></pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">trace</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">10</span><span class="p">])</span>
</pre></div>
</div>
</div>
<p>We can now visualize what the whole trace looks like.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">hv</span><span class="o">.</span><span class="n">extension</span><span class="p">(</span><span class="s2">&quot;bokeh&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_trace</span><span class="p">(</span><span class="n">trace</span><span class="p">)</span><span class="o">.</span><span class="n">opts</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="mi">950</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">600</span><span class="p">)</span>
</pre></div>
</div>
</div>
</section>
<section id="SPA">
<h3>SPA<a class="headerlink" href="#SPA" title="Link to this heading">¶</a></h3>
<p>We can now analyze the trace and try to gain information about the execution of the algorithm and/or recover the secret scalar.</p>
<p>We apply rolling mean to the trace to smooth it out, reduce noise and make the actions executed during the algorithm better identifiable.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">spa_trace</span> <span class="o">=</span> <span class="n">rolling_mean</span><span class="p">(</span><span class="n">trace</span><span class="p">,</span> <span class="mi">3000</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>We can see repeated patterns in the resulting trace. Since the emulation consists of performing either point addition or point doubling repeadetly, we can map their execution to the repeated patterns. We know that the doubling operation will be performed for each bit of the scalar, while the addition operation will be performed only when the currently processed bit of the scalar is equal to one. Using this knowledge, we can see in the trace that the order of executed operations is as follows:
<em>dbl-add-dbl-add-dbl-dbl-dbl-add-dbl-dbl-add</em>. This means that the scalar used equals <em>11100101 = 229</em>.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_trace</span><span class="p">(</span><span class="n">spa_trace</span><span class="p">)</span><span class="o">.</span><span class="n">opts</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="mi">950</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">600</span><span class="p">)</span>
</pre></div>
</div>
</div>
</section>
</section>
</section>


          </div>
          
        </div>
      </div>
    <div class="clearer"></div>
  </div>
    <div class="footer">
      &#169;2018-2024, Jan Jancar.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 7.4.5</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 0.7.16</a>
      
      |
      <a href="../_sources/notebook/emulator.ipynb.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>